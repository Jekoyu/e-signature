default:
  tags:
    - vps-runner

include:
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml

image: node:20

stages:
  - install
  - validate
  - test
  - deploy

cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - node_modules/
    - .pnpm-store/
  policy: pull-push

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == 'main'

# =========================
# INSTALL
# =========================
install_dependencies:
  stage: install
  script:
    - npm install -g pnpm
    - pnpm install --frozen-lockfile

# =========================
# VALIDATE
# =========================
validate_code:
  stage: validate
  needs: [install_dependencies]
  script:
    - echo "Skipping lint (script not defined in package.json)"
    # - npm install -g pnpm
    # - pnpm run lint

# =========================
# TEST
# =========================
test_app:
  stage: test
  needs: [install_dependencies]
  script:
    - echo "Skipping tests (script not defined in package.json)"
    # - npm install -g pnpm
    # - pnpm run test

# =========================
# DEPLOY (STAGING)
# =========================
deploy_staging:
  stage: deploy
  image: alpine:latest
  needs:
    - validate_code
    - test_app
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
  variables:
    # Server Configuration
    SSH_HOST: '72.62.73.234'
    SSH_USER: 'root'
    SSH_PORT: '22'
    # Adjusted path for this project
    DEPLOY_PATH: '~/rentverse/stagging/rentverse-docs'
  before_script:
    - apk add --no-cache openssh rsync
    - mkdir -p ~/.ssh
    # Setup SSH key
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan -p ${SSH_PORT} ${SSH_HOST} >> ~/.ssh/known_hosts
  script:
    # Create .env file from base64-encoded GitLab variable
    - echo "$ENV_FILE_BASE64" | base64 -d > .env

    # Deploy files to server (including .env and docker-compose.yml)
    - rsync -avz --delete --exclude='.git/' --exclude='node_modules/' --exclude='uploads/' --exclude='.gitlab-ci.yml' ./ ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/

    # Run docker compose on server
    - ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && docker compose down && docker compose up -d --build"

    # Wait for container to be healthy and show logs for debugging
    - ssh ${SSH_USER}@${SSH_HOST} "cd ${DEPLOY_PATH} && sleep 10 && docker compose ps && docker compose logs --tail=50"
